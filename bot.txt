
import asyncio
import logging
import requests
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message

BOT_TOKEN = "7526254974:AAHHM_7N4mW59Vp2E1vJ_qtoklkpudxfvLg"

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def send_welcome(message: Message):
    user_name = message.from_user.first_name if message.from_user.first_name else "ØµØ¯ÙŠÙ‚ÙŠ"
    
    await bot.send_chat_action(message.chat.id, "typing")
    await asyncio.sleep(1)
    await message.answer(f"âœ¨ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ {user_name}! Ø³Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ Ø¨ÙˆØ¬ÙˆØ¯Ùƒ Ù…Ø¹Ø§Ù†Ø§ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©! ğŸ˜Š")
    
    await bot.send_chat_action(message.chat.id, "typing")
    await asyncio.sleep(1.2)
    await message.answer("ğŸ¤– Ø§Ø³Ù…Ø­ Ù„ÙŠ Ø£Ø¹Ø±ÙÙƒ Ø¨Ù†ÙØ³ÙŠ.. Ø£Ù†Ø§ BaymaxØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ³Ù‡Ù„Ùƒ ÙƒÙ„ Ø­Ø§Ø¬Ø© ÙˆÙ‡ÙŠØ®Ø¯Ù…Ùƒ Ø¨ÙƒÙ„ Ø³Ø¹Ø§Ø¯Ø©")
    
    await bot.send_chat_action(message.chat.id, "typing")
    await asyncio.sleep(1.5)
    await message.answer("ğŸ’« Ø£Ù†Ø§ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ØªØ´ÙˆÙ ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒØŒ ÙˆÙ‡Ø­Ø§ÙˆÙ„ Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ø£ÙƒÙˆÙ† Ø¹Ù†Ø¯ Ø­Ø³Ù† Ø¸Ù†Ùƒ")
    
    await bot.send_chat_action(message.chat.id, "typing")
    await asyncio.sleep(1.3)
    await message.answer(
        f"ğŸ“ Ø¹Ù„Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙŠØ§ {user_name}ØŒ Ù…Ø­ØªØ§Ø¬ Ù…Ù†Ùƒ ØªØ¨Ø¹Øª Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠ:\n\n"
        "host: http://example.com:8080\n"
        "username: Ø§Ù„ÙŠÙˆØ²Ø± Ø¨ØªØ§Ø¹Ùƒ\n"
        "password: Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯\n\n"
        "ÙˆØ£Ù†Ø§ Ù‡Ø¬ÙŠØ¨ Ù„Ùƒ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ù…Ø­ØªØ§Ø¬Ù‡Ø§ Ø¹Ù„Ù‰ Ø·ÙˆÙ„! ğŸš€"
    )

def parse_subscription_info(text):
    lines = text.split('\n')
    data = {}
    for line in lines:
        if line.lower().startswith("host:"):
            data['host'] = line.split("host:")[1].strip()
        elif line.lower().startswith("username:"):
            data['username'] = line.split("username:")[1].strip()
        elif line.lower().startswith("password:"):
            data['password'] = line.split("password:")[1].strip()
    return data

def format_date(timestamp):
    from datetime import datetime
    try:
        dt = datetime.fromtimestamp(int(timestamp))
        months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø¥Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", 
                 "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"]
        return f"{dt.day} {months[dt.month-1]} {dt.year}"
    except:
        return timestamp

def check_subscription(host, username, password):
    try:
        session = requests.Session()
        url = f"{host}/player_api.php?username={username}&password={password}"
        response = session.get(url, timeout=3)
        if response.status_code != 200:
            return None
        data = response.json()
        if "user_info" not in data:
            return None
            
        # Get media counts with reduced timeout and parallel requests
        live_count = session.get(f"{host}/player_api.php?username={username}&password={password}&action=get_live_streams", timeout=3).json()
        vod_count = session.get(f"{host}/player_api.php?username={username}&password={password}&action=get_vod_streams", timeout=3).json()
        series_count = session.get(f"{host}/player_api.php?username={username}&password={password}&action=get_series", timeout=3).json()
        
        user_info = data['user_info']
        return {
            "status": user_info.get("status"),
            "created": format_date(user_info.get("created_at")),
            "exp_date": format_date(user_info.get("exp_date")),
            "active_cons": user_info.get("active_cons"),
            "max_connections": user_info.get("max_connections"),
            "live_count": len(live_count) if isinstance(live_count, list) else 0,
            "vod_count": len(vod_count) if isinstance(vod_count, list) else 0,
            "series_count": len(series_count) if isinstance(series_count, list) else 0
        }
    except Exception as e:
        logging.error(f"Error checking subscription: {e}")
        return None

@dp.message()
async def handle_subscription(message: Message):
    if message.text.startswith("/"):  # Skip command messages
        return
        
    # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªØ±Ø­ÙŠØ¨
    thank_words = ["Ø´ÙƒØ±Ø§", "Ø´ÙƒØ±Ø§Ù‹", "Ø´ÙƒØ±Ù‹Ø§", "thanks", "thank you"]
    hello_words = ["Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…", "Ù‡Ø§ÙŠ", "Ù‡Ù„Ø§", "Ù…Ø±Ø­Ø¨Ø§", "hi", "hello"]
    
    user_name = message.from_user.first_name if message.from_user.first_name else "ØµØ¯ÙŠÙ‚ÙŠ"
    
    if any(word in message.text.lower() for word in thank_words):
        await bot.send_chat_action(message.chat.id, "typing")
        await asyncio.sleep(1)
        responses = [
            f"Ø§Ù„Ø¹ÙÙˆ Ø®Ø§Ù„Øµ ÙŠØ§ {user_name}! ğŸŒ¹ Ø³Ø¹ÙŠØ¯ Ø¥Ù†ÙŠ Ù‚Ø¯Ø±Øª Ø£Ø³Ø§Ø¹Ø¯Ùƒ",
            f"Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ Ø§Ù„Ø´ÙƒØ± ÙŠØ§ {user_name}! Ø¯ÙŠ Ø­Ø§Ø¬Ø© Ø¨Ø³ÙŠØ·Ø© ğŸ’",
            "Ø¯Ù‡ Ø´Ø±Ù Ù„ÙŠØ§ Ø¥Ù†ÙŠ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ! Ø§Ø­Ù†Ø§ Ø¯Ø§ÙŠÙ…Ø§Ù‹ ÙÙŠ Ø®Ø¯Ù…ØªÙƒ ğŸŒŸ",
            "Ù…ØªØ´ÙƒØ±Ø´ ÙŠØ§ ØºØ§Ù„ÙŠ! Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© Ù…Ø­ØªØ§Ø¬Ù‡Ø§ØŒ Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯ ğŸ’«"
        ]
        await message.answer(responses[hash(str(message.date)) % len(responses)])
        return
        
    if any(word in message.text.lower() for word in hello_words):
        await bot.send_chat_action(message.chat.id, "typing")
        await asyncio.sleep(1)
        responses = [
            f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ {user_name}! ğŸŒŸ Ø¥Ø²ÙŠÙƒ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ",
            f"Ù…Ù†ÙˆØ± ÙŠØ§ {user_name}! âœ¨ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø¥ÙŠÙ‡ØŸ",
            "ÙŠØ§ Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ğŸ˜Š Ø£Ù†Ø§ Ø³Ø¹ÙŠØ¯ Ø¨ÙˆØ¬ÙˆØ¯Ùƒ Ù…Ø¹Ø§Ù†Ø§",
            f"Ù‡Ù„Ø§ Ø¨ÙŠÙƒ ÙŠØ§ {user_name}! ğŸ’« ØªØ­Øª Ø£Ù…Ø±Ùƒ ÙÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø©"
        ]
        await message.answer(responses[hash(str(message.date)) % len(responses)])
        return
        
    await bot.send_chat_action(message.chat.id, "typing")
    await asyncio.sleep(0.1)

    info = parse_subscription_info(message.text)
    if not info or 'host' not in info or 'username' not in info or 'password' not in info:
        await message.answer("ÙŠØ§ Ù…Ø¹Ù„Ù… Ø§Ù†Øª Ù†Ø³ÙŠØª Ø­Ø§Ø¬Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ø·Ø¨ Ø¨Øµ Ø§ÙƒØªØ¨Ù‡Ù…Ù„ÙŠ ÙƒØ¯Ù‡ ØªØ§Ù†ÙŠ ÙŠØ§ ÙƒØ¨ÙŠØ±:\n"
                           "host: http://example.com:8080\n"
                           "username: Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n"
                           "password: Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯")
        return

    result = check_subscription(info['host'], info['username'], info['password'])

    if result:
        await bot.send_chat_action(message.chat.id, "typing")
        await asyncio.sleep(0.3)
        is_trial = "Ù†Ø¹Ù…" if result.get('is_trial') else "Ù„Ø§"
        status = "Ù†Ø´Ø·" if result['status'] == "Active" else "ØºÙŠØ± Ù†Ø´Ø·"
        
        reply = (
            "ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ø­Ø¶Ø±ØªÙƒ ğŸŒŸ\n\n"
            f"ğŸ‘¤ Ø¥Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… : {info['username']}\n"
            f"â­ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ : {status}\n"
            f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø¥Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ : {result['exp_date']}\n"
            f"ğŸ¯ Ù‡Ù„ Ø§Ù„Ø¥Ø´ØªØ±Ø§Ùƒ ØªØ¬Ø±ÙŠØ¨ÙŠ : {is_trial}\n"
            f"ğŸ“± Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù† : {result['active_cons']}\n"
            f"ğŸ“† ØªØ§Ø±ÙŠØ® Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ : {result['created']}\n"
            f"ğŸ’« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ù‚ØµÙ‰ : {result['max_connections']}\n"
            f"ğŸ“º Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª : {result['live_count']}\n"
            f"ğŸ¬ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙÙ„Ø§Ù… : {result['vod_count']}\n"
            f"ğŸ¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª : {result['series_count']}\n\n"
            "â¤ï¸ Ø£ØªÙ…Ù†Ù‰ Ø£ÙƒÙˆÙ† Ø£ÙØ¯ØªÙƒ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯ÙŠ"
        )
    else:
        reply = "âŒ Ø¨Øµ ÙŠØ§ Ù…Ø¹Ù„Ù…ØŒ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠ Ø§Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ø±Ø§Ø¶ÙŠ ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙ†Ø§ Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ˜”\nÙ…Ù…ÙƒÙ† ØªØ´ÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙˆÙŠØ³ ÙˆØªØ¬Ø±Ø¨ ØªØ§Ù†ÙŠ ÙŠØ§ ÙƒØ¨ÙŠØ±ØŸ ğŸ™"

    await message.answer(reply)

async def main():
    # ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ù…Ø³ØªÙˆÙ‰ WARNING Ù„Ù„Ø­Ø¯ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    logging.basicConfig(level=logging.WARNING)
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø¯Ø¯ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ ÙˆÙ‚Øª ÙˆØ§Ø­Ø¯
    dp.startup.register(on_startup)
    dp.shutdown.register(on_shutdown)
    
    # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
    await dp.start_polling(
        bot,
        allowed_updates=["message", "callback_query"],  # ØªØ­Ø¯ÙŠØ¯ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·
        polling_timeout=60,  # Ø²ÙŠØ§Ø¯Ø© Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹
        handle_signals=True,  # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    )

async def on_startup():
    # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
    await bot.delete_webhook(drop_pending_updates=True)  # ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©

async def on_shutdown():
    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª
    await bot.session.close()

if __name__ == "__main__":
    asyncio.run(main())
